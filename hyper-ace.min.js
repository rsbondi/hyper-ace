var hyperace=function(){};hyperace.create=function(a,b,c,d){return new hyperace.hypersearch(a,b,c,d)};
hyperace.hypersearch=function(a,b,c,d){this.activeEditor=0;this.ranges=null;this.anchors=[];this.currentSession=0;this.editor=a;this.target=document.getElementById(b);this.textbox=document.getElementById(c);this.options=d?d:[];d?(this.options.matchclass=d.matchclass?d.matchclass:"hyperace-match",this.options.lineclass=d.lineclass?d.lineclass:"hyperace-line"):(this.options.matchclass="hyperace-match",this.options.lineclass="hyperace-line");this.sessions=Array(a.getSession())};
hyperace.hypersearch.prototype={setSessions:function(a){this.sessions=a;for(s in this.sessions){this.currentSession=s;console.log("initial session set to: "+s);break}},set:function(a){this.editor.$search.set(a)},searchSessions:function(){this.target.innerHTML="";this.ranges=[];this.anchors=[];var a=this.editor,b=a.getSession();for(s in this.sessions){this.anchors[s]=[];var c=document.createElement("div");c.innerHTML=s;c.className="hyperace-session";this.target.appendChild(c);a.getSelection().getAllRanges();
this._search(this.sessions[s],s);console.log("session: "+s+": "+this.ranges[s].length+" matches.");0==this.ranges[s].length&&this.target.removeChild(c)}a.setSession(b)},search:function(){this.target.innerHTML="";this.ranges=[];this.anchors=[];this.anchors[this.currentSession]=[];if(0!=this.currentSession){var a=document.createElement("div");a.innerHTML=this.currentSession;a.className="hyperace-session";this.target.appendChild(a)}this._search(this.editor.getSession(),this.currentSession);console.log("searching single session: "+
this.currentSession)},_search:function(a,b){console.log("hypersearch activated for expression: "+this.textbox.value);var c=this.editor;a&&c.setSession(a);var d=c.findAll(this.textbox.value);0==d&&c.clearSelection();console.log("found "+d+" matches in "+b);this.ranges[b]=c.getSelection().getAllRanges();console.log(JSON.stringify(this.ranges[b]));c.exitMultiSelectMode();for(r=0;r<this.ranges[b].length;r++)this.anchors[b].push(c.getSession().getDocument().createAnchor(this.ranges[b][r].start.row,this.ranges[b][r].start.column)),
this._addResult(r,b)},_addResult:function(a,b){if(this.ranges[b][a].start.row==this.ranges[b][a].end.row&&this.ranges[b][a].start.column==this.ranges[b][a].end.column)this.ranges[b]=[];else{var c=this.ranges[b][a].start.row,d=this.ranges[b][a].start.column;console.log("found row index "+a+" @ line: "+c);var g=document.createElement("div"),e=document.createElement("a");g.appendChild(e);e.href="javascript:void(0)";e.setAttribute("data-index",a);g.setAttribute("data-session",b?b:0);var f=this.editor.getSession().getLine(c),
h=f.substr(0,this.ranges[b][a].start.column),k=f.substr(this.ranges[b][a].start.column,this.ranges[b][a].end.column-this.ranges[b][a].start.column),m=f.substr(this.ranges[b][a].end.column);console.log("line: "+f+"\npre: "+h+"\nmatch: "+k+"\npost: "+m);f=this.htmlEncode(h)+'<span class="'+this.options.matchclass+'">'+this.htmlEncode(k)+"</span>"+this.htmlEncode(m);e.innerHTML+="("+(c+1)+","+(d+1)+") "+f+"<br/>";var n=this;e.addEventListener("click",function(){var a=this.getAttribute("data-index");
n._linkSelected(a,this.parentNode)});this.target.appendChild(g)}},clear:function(){this.target.innerHTML=""},_linkSelected:function(a,b){console.log("link selected for session: "+b.getAttribute("data-session")+" at index: "+a);var c=this.editor,d=this.anchors[b.getAttribute("data-session")][a].getPosition(),g=ace.require("ace/range").Range;this.currentSession=b.getAttribute("data-session");console.log("session changeing to: "+this.currentSession);this.setSession(this.currentSession);c.focus();c.moveCursorTo(d.row,
d.column);var e=this.ranges[b.getAttribute("data-session")][a];c.selection.setRange(new g(d.row,d.column,d.row,e.end.column+d.column-e.start.column));c=this.target.getElementsByTagName("div");for(l in c)this.options.lineclass==c[l].className&&(c[l].className="");b.className=this.options.lineclass},setSession:function(a){this.editor.setSession(this.sessions[a]);this.currentSession=a;console.log("session changed to: "+a)},htmlEncode:function(a){return a.replace(/&/g,"&amp;").replace(/ /g,"&nbsp;").replace(/\t/g,
"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/</g,"&lt;").replace(/\n/g,"<br/>").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}};
