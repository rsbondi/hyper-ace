var hyperace=function(){};hyperace.create=function(b,c,d,e){return new hyperace.hypersearch(b,c,d,e)};
hyperace.hypersearch=function(b,c,d,e){this.activeEditor=0;this.ranges=null;this.anchors=[];this.currentSession=0;this.editor=b;this.searchMultiSession=!1;this.target=document.getElementById(c);d?this.textbox=document.getElementById(d):this._acebox();this.options=e?e:[];e?(this.options.matchclass=e.matchclass?e.matchclass:"hyperace-match",this.options.lineclass=e.lineclass?e.lineclass:"hyperace-line"):(this.options.matchclass="hyperace-match",this.options.lineclass="hyperace-line");this.sessions=
Array(b.getSession());this._anchorValidation(0)};
hyperace.hypersearch.prototype={setSessions:function(b){this.sessions=b;for(s in this.sessions){this.currentSession=s;break}for(s in this.sessions)this._anchorValidation(s)},setSession:function(b){this.editor.setSession(this.sessions[b]);this.currentSession=b},set:function(b){this.editor.$search.set(b)},clear:function(){this.target.innerHTML="";this.ranges=[];this.anchors=[]},searchSessions:function(){this.target.innerHTML="";this.ranges=[];this.anchors=[];var b=this.editor,c=b.getSession();for(s in this.sessions){this.anchors[s]=
[];var d=document.createElement("div");d.innerHTML=s;d.className="hyperace-session";this.target.appendChild(d);this._search(this.sessions[s],s);0==this.ranges[s].length&&this.target.removeChild(d)}b.setSession(c)},search:function(){this.target.innerHTML="";this.ranges=[];this.anchors=[];this.anchors[this.currentSession]=[];if(0!=this.currentSession){var b=document.createElement("div");b.innerHTML=this.currentSession;b.className="hyperace-session";this.target.appendChild(b)}this._search(this.editor.getSession(),
this.currentSession)},_search:function(b,c){var d=this.editor;b&&d.setSession(b);0==d.findAll(this.textbox.value)&&d.clearSelection();this.ranges[c]=d.getSelection().getAllRanges();d.exitMultiSelectMode();for(r=0;r<this.ranges[c].length;r++)this.anchors[c].push(d.getSession().getDocument().createAnchor(this.ranges[c][r].start.row,this.ranges[c][r].start.column)),this._addResult(r,c)},_addResult:function(b,c){if(this.ranges[c][b].start.row==this.ranges[c][b].end.row&&this.ranges[c][b].start.column==
this.ranges[c][b].end.column)this.ranges[c]=[];else{var d=this.ranges[c][b].start.row,e=this.ranges[c][b].start.column,f=document.createElement("div"),g=document.createElement("a");f.appendChild(g);g.href="javascript:void(0)";g.setAttribute("data-index",b);f.setAttribute("data-session",c?c:0);var h=this.editor.getSession().getLine(d),k=h.substr(0,this.ranges[c][b].start.column),m=h.substr(this.ranges[c][b].start.column,this.ranges[c][b].end.column-this.ranges[c][b].start.column),h=h.substr(this.ranges[c][b].end.column),
k=this._htmlEncode(k)+'<span class="'+this.options.matchclass+'">'+this._htmlEncode(m)+"</span>"+this._htmlEncode(h);g.innerHTML+="("+(d+1)+","+(e+1)+") "+k+"<br/>";var n=this;g.addEventListener("click",function(){var b=this.getAttribute("data-index");n._linkSelected(b,this.parentNode)});this.target.appendChild(f)}},_linkSelected:function(b,c){var d=this.editor,e=this.anchors[c.getAttribute("data-session")][b].getPosition(),f=ace.require("ace/range").Range,g=c.getAttribute("data-session");g!=this.currentSession&&
(this.currentSession=g,this.setSession(this.currentSession));d.focus();d.moveCursorTo(e.row,e.column);g=this.ranges[g][b];d.selection.setRange(new f(e.row,e.column,e.row,g.end.column+e.column-g.start.column));d=this.target.getElementsByTagName("div");for(l in d)this.options.lineclass==d[l].className&&(d[l].className="");c.className=this.options.lineclass},_acebox:function(){var b=this;ace.config.loadModule("ace/ext/searchbox",function(c){c.Search(b.editor);b.textbox=b.editor.container.getElementsByClassName("ace_search_field")[0];
b.textbox.id="hyperbox";b.textbox.addEventListener("keyup",function(c){9==c.keyCode&&(b.searchMultiSession?b.searchSessions():b.search())});b.editor.container.getElementsByClassName("ace_search")[0].style.display="none";b.options&&"function"==typeof b.options.load&&b.options.load(c)})},_anchorValidation:function(b){var c=this;this.sessions[b].on("change",function(b){b=b.data;if("removeText"===b.action||"removeLines"===b.action){var e=b.range;for(a in c.anchors[c.currentSession]){var f=c.anchors[c.currentSession][a];
if("removeText"===b.action&&e.end.column>f.column&&e.start.row===f.row&&e.start.column<=f.column||"removeLines"===b.action&&e.start.row<=f.row&&e.end.row>f.row)c.anchors[c.currentSession][a].detach(),(f=c._getResult(c.currentSession,a))&&f.parentNode.removeChild(f)}}})},_getResult:function(b,c){var d=this.target.getElementsByTagName("div");for(s=0;s<d.length;s++)if(d[s].getAttribute("data-session")==b&&d[s].getElementsByTagName("a")[0].getAttribute("data-index")==c)return d[s]},_htmlEncode:function(b){return b.replace(/&/g,
"&amp;").replace(/ /g,"&nbsp;").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/</g,"&lt;").replace(/\n/g,"<br/>").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}};
